<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FFC in R: Simple Functional Flows Calculator API Client • ffcAPIClient</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="FFC in R: Simple Functional Flows Calculator API Client">
<meta property="og:description" content="ffcAPIClient">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ffcAPIClient</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.8.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ceff-steps.html">Use ffcAPIClient to Follow CEFF Steps</a>
    </li>
    <li>
      <a href="../articles/README.html">FFC in R: Simple Functional Flows Calculator API Client</a>
    </li>
    <li>
      <a href="../articles/run_multiple_gages.html">Use ffcAPIClient to Run Multiple Gages</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>FFC in R: Simple Functional Flows Calculator API Client</h1>
            
      
      
      <div class="hidden name"><code>README.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>This package is designed to:</p>
<ol style="list-style-type: decimal">
<li>Process either user data or existing gage data through the online functional flows calculator (<a href="eflows.ucdavis.edu">eflows.ucdavis.edu</a>).</li>
<li>Transform that data and generate functional flow metrics, predicted percentiles, alteration assessments, as well as return plots of the Dimensionless Reference Hydrograph (DRH) and boxplots showing the observed versus predicted percentile values for each metric.</li>
<li>Provide functions that follow the <a href="https://ceff.ucdavis.edu/">CEFF Steps</a>: see <a href="#step-one"><strong>Step One</strong></a>, <a href="#step-two"><strong>Step Two</strong></a>, and <a href="#step-three"><strong>Step Three</strong></a> below.</li>
<li>In addition, there are shortcut functions that provide direct access to useful intermediate products, such as the functional flow metric results or alteration assessment data as R dataframes.</li>
</ol>
<p>It is meant to be used with either a gage ID, or with a timeseries dataframe with a column of flow values and a column of date values and a user-supplied COMID value for the stream segment or latitude and longitude. See <a href="#setup"><strong>Setup</strong></a> and <a href="#examples"><strong>Examples</strong></a> below for more.</p>
<p><a href="https://travis-ci.org/ceff-tech/ffc_api_client"><img src="https://travis-ci.org/ceff-tech/ffc_api_client.svg?branch=master" alt="Code Testing Status"></a></p>
</div>
<div id="full-documentation" class="section level2">
<h2 class="hasAnchor">
<a href="#full-documentation" class="anchor"></a>Full Documentation</h2>
<p>There are many examples below, including instructions on how to set up and use the core parts of the package. Check the documentation for the classes and functions in this site and especially in the “articles” provided at the top. We also publish a <a href="./manuals/ffcAPIClient_latest.pdf">PDF version of this manual</a>.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>To get this package up and running, you’ll want to make sure you have the most recent R version available (download <a href="https://cran.r-project.org/">here</a>). In addition, you’ll need the the {<code>devtools</code>} package. Basic installation instructions as follows:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Get {<code>devtools</code>} installed</strong>: If you don’t already have it, run <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages('devtools')</a></code> in your R console, or install the package any way you prefer.</p></li>
<li>
<p><strong>Install the {<code>ffcAPIClient</code>} package</strong>:</p>
<ul>
<li><code><a href="https://devtools.r-lib.org//reference/remote-reexports.html">devtools::install_github('ceff-tech/ffc_api_client/ffcAPIClient')</a></code></li>
<li>If you get an error on this installation step, make sure you are using the latest version of R and of the {<code>devtools</code>} package.</li>
</ul>
</li>
<li>
<p><strong>Retrieve your eflows API token</strong>: Now we need to retrieve your token.</p>
<ol style="list-style-type: lower-alpha">
<li>In Firefox or Chrome, log into <a href="https://eflows.ucdavis.edu" class="uri">https://eflows.ucdavis.edu</a>. Once logged in, make sure you are on your user profile page at <a href="https://eflows.ucdavis.edu/profile" class="uri">https://eflows.ucdavis.edu/profile</a> and then press <code>F12</code> on your keyboard to bring up the Inspector, then switch to the Console tab.</li>
<li>In the console, type <code>localStorage.getItem('ff_jwt')</code>—you may need to type it in yourself instead of pasting (or follow Firefox’s instructions to enable pasting—it will tell you how after you try to paste). Hit <code>Enter</code> to send the command.</li>
<li>Your browser will place text on the line below the command you typed - this is your “token”. Save this value and copy it to your clipboard and we’ll use it below. This value should stay private—if other people knew the value, they could use it to access your account on <a href="eflows.ucdavis.edu">eflows.ucdavis.edu</a>.</li>
</ol>
</li>
<li>
<p><strong>Save Your Token</strong>: One recommended option is to save your token is with the <a href="https://usethis.r-lib.org/">{<code>usethis</code>}</a> package. To do so, install the package and then run <code><a href="https://usethis.r-lib.org/reference/edit.html">usethis::edit_r_environ()</a></code> to edit your <code>.Renviron</code>. Add your token as shown below, make sure there is an empty line at the bottom of the file, and save the file.</p>
<pre><code>EFLOWS_TOKEN='very_long_string_of_letters_and_numbers`</code></pre>
<p>Once you have saved your token in your <code>.Renviron</code> file, restart R, and you can access it via: <code>ffctoken &lt;- set_token(Sys.getenv("EFLOWS", ""))</code> and use <code>ffctoken</code> instead of pasting your full key.</p>
</li>
</ol>
<p><br></p>
<p>That’s it. You can now run data through the online FFC using this package and process the results.</p>
<hr>
</div>
<div id="usage-examples" class="section level2">
<h2 class="hasAnchor">
<a href="#usage-examples" class="anchor"></a>Usage Examples</h2>
<p>There are more detailed tutorials available under the <strong>Articles</strong> menu, including:</p>
<ul>
<li><a href="https://ceff-tech.github.io/ffc_api_client/articles/ceff-steps.html"><strong>Following the CEFF Steps Vignette</strong></a></li>
<li><a href="https://ceff-tech.github.io/ffc_api_client/articles/run_multiple_gages.html"><strong>How to pull FFC data for multiple USGS Gages</strong></a></li>
</ul>
<p>It’s recommended you run the steps above on your own, but the package includes other ways to run similar workflows for gage data or for timeseries data of your own. The general steps to run anything require your token, and initializing a processor to run data through.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ffcAPIClient</span>)

<span class="co"># start ffc processor</span>
<span class="no">ffc</span> <span class="kw">&lt;-</span> <span class="no">FFCProcessor</span>$<span class="fu">new</span>()</pre></body></html></div>
<div id="ffc-for-a-single-usgs-gage" class="section level3">
<h3 class="hasAnchor">
<a href="#ffc-for-a-single-usgs-gage" class="anchor"></a>FFC for a Single USGS Gage</h3>
<p>To calculate functional flow metrics (FFM) for a single gage, we need to provide the gage and the token. We can also provide the COMID and plot_output_folder (where all the results and plots go), but these are optional. If you don’t specify an output folder, the results end up in your R environment and you can save them later.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># set token if in .Rprofile:</span>
<span class="no">ffctoken</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/set_token.html">set_token</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span>(<span class="st">"EFLOWS"</span>, <span class="st">""</span>))

<span class="co"># or just add manually:</span>
<span class="no">ffctoken</span> <span class="kw">&lt;-</span> <span class="st">"MYVERYLONGTOKEN_NUMBER_HERE"</span>

<span class="co"># start ffc processor</span>
<span class="no">ffc</span> <span class="kw">&lt;-</span> <span class="no">FFCProcessor</span>$<span class="fu">new</span>()
<span class="no">ffc</span>$<span class="fu">set_up</span>(<span class="kw">gage_id</span> <span class="kw">=</span> <span class="fl">11427000</span>,
           <span class="kw">token</span> <span class="kw">=</span> <span class="no">ffctoken</span>,
           <span class="co"># OPTIONAL</span>
           <span class="kw">comid</span> <span class="kw">=</span> <span class="no">segment_comid</span>,
           <span class="kw">plot_output_folder</span> <span class="kw">=</span> <span class="st">"~/Documents/NFA_Gage_Alteration"</span>)</pre></body></html></div>
<p>After running the <code>ffc$set_up()</code>, we should get back some information about the <code>ffcAPIClient</code> version, as well as message stating how many water years will be excluded because of more than 7 days of missing data.</p>
<pre><code>INFO [2020-11-21 12:00:00] ffcAPIClient Version 0.9.8.2
INFO [2020-11-21 12:00:00] Excluding water years 2021 for having more than 7 missing days of data</code></pre>
<p>Finally, we run the calculator, which will return all our data in the <strong><code>ffc</code></strong> object, see below.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">ffc</span>$<span class="fu">run</span>()</pre></body></html></div>
<pre><code>INFO [2020-11-21 12:00:00] Using date format string %m/%d/%Y
INFO [2020-11-21 12:00:00] COMID 14996611 is of stream class LSR - sending parameters to FFC online for that stream class. This may produce different results than if you run data through the FFC yourself using their default parameters.</code></pre>
<p>The <strong><code>ffc</code></strong> object contains all the data we may be interested in including:</p>
<ul>
<li>
<code>ffc_results</code> includes the raw data from the functional flows calculator for each flow metric by day of water year.</li>
<li>
<code>ffc_percentiles</code> includes the calculated 10th, 25th, 50th, 75th, and 90th percentiles for each metric.</li>
<li>
<code>alteration</code> data frame includes the assessed alteration of each metric using CEFF Appendix F Rules.</li>
<li>
<code>predicted_percentiles</code> includes the same percentiles as predicted for each metric for assessing the observed ffc results against predicted unaltered flow.</li>
<li>
<code>doh_data</code> contains the raw dimensionless hydrograph data with columns for percentiles and rows for days of water year.</li>
</ul>
<p>See the <a href="#documentation">documentation</a> for more information on these results.</p>
<p>We can save each of these individually however we choose using something like <code>write.csv(ffc$ffc_results, file="my_output_folder/ffc_results.csv)</code>. However, to save everything all at once, see below to learn how to <a href="#save-all-the-ffc-results-into-a-single-folder">Save All Results into a Single Folder</a>.</p>
</div>
<div id="save-results-in-a-single-folder" class="section level3">
<h3 class="hasAnchor">
<a href="#save-results-in-a-single-folder" class="anchor"></a>Save Results In a Single Folder</h3>
<p>If we want to save all the above results to a folder directly, we can use the <strong><code><a href="../reference/evaluate_gage_alteration.html">evaluate_gage_alteration()</a></code></strong> function. This will get all the results and save them to a single directory you specify. It requires the same arguments as above. However, the <code>plot_output_folder</code> remains optional, and when provided, plots and data will be saved in that location. Plots will show in your R environment (the <code>Plots</code> tab in RStudio) regardless.</p>
<p>Providing the COMID is preferred, though there are look up options available. See the function documentation for details regarding how to optionally re-enable the lookup.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># If you have a gage and a token, you can get all results simply by running</span>
<span class="kw pkg">ffcAPIClient</span><span class="kw ns">::</span><span class="fu"><a href="../reference/evaluate_gage_alteration.html">evaluate_gage_alteration</a></span>(<span class="kw">gage_id</span> <span class="kw">=</span> <span class="fl">11427000</span>,
                                       <span class="kw">token</span> <span class="kw">=</span> <span class="st">"your_token"</span>,
                                       <span class="kw">comid</span> <span class="kw">=</span> <span class="no">segment_comid</span>,
                                       <span class="kw">plot_output_folder</span> <span class="kw">=</span> <span class="st">"C:/Users/youruser/Documents/NFA_Gage_Alteration"</span>)</pre></body></html></div>
</div>
<div id="ffc-with-your-own-flow-data" class="section level3">
<h3 class="hasAnchor">
<a href="#ffc-with-your-own-flow-data" class="anchor"></a>FFC with Your Own Flow Data</h3>
<p>If you have your own flow data, as long as it is a data frame with flow and date fields, we can use the same functions as described above. However, we need to specify the dataframe containing:</p>
<ul>
<li>
<code>flow</code> column with daily flow data</li>
<li>
<code>date</code> column, ideally formatted as “YYYY-MM-DD”</li>
</ul>
<p>To run this data, we can use the following, note, the date format default is for “YYYY-MM-DD” but you can specify an alternate format (type <code><a href="https://rdrr.io/r/base/strptime.html">?strptime</a></code> in your R console to see the Help file with date specifications). <strong>Note</strong>, <code>COMID</code> is required or a <code>latitude/longitude</code> must be provided.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="kw pkg">ffcAPIClient</span><span class="kw ns">::</span><span class="fu"><a href="../reference/evaluate_alteration.html">evaluate_alteration</a></span>(
  <span class="kw">timeseries_df</span> <span class="kw">=</span> <span class="no">your_df</span>,
  <span class="kw">token</span> <span class="kw">=</span> <span class="st">"your_token"</span>,
  <span class="kw">plot_output_folder</span> <span class="kw">=</span> <span class="st">"C:/Users/youruser/Documents/Timeseries_Alteration"</span>,
  <span class="kw">comid</span><span class="kw">=</span><span class="no">yoursegmentcomid</span>) <span class="co"># REQUIRED OR specify lat/lon</span>
<span class="co"># additional arguments:</span>
  <span class="co"># longitude = ,</span>
  <span class="co"># latitude = ,</span>
  <span class="co"># plot_results = TRUE, # default is TRUE</span>
  <span class="co"># plot_output_folder = , # where to save things</span>
  <span class="co"># date_format_string = "") # to specify a custom date format, default is YYYY-MM-DD)</span></pre></body></html></div>
<p>This function, and <code><a href="../reference/evaluate_gage_alteration.html">evaluate_gage_alteration()</a></code>, plot results immediately and optionally save the plots to the output folder.</p>
</div>
<div id="getting-predicted-flow-metrics-from-a-comid" class="section level3">
<h3 class="hasAnchor">
<a href="#getting-predicted-flow-metrics-from-a-comid" class="anchor"></a>Getting Predicted Flow Metrics from a COMID</h3>
<p>This package compares the percentiles generated from the observed data and the percentiles predicted by modeling. As part of this functionality, the code includes the full results of the modeling output as a data frame accessible in <code><a href="../reference/flow_metrics.html">ffcAPIClient::flow_metrics</a></code>. More practically, if you have a variable <code>com_id</code> that stores an NHD stream segment identifier (COMID), then you can also use <code><a href="../reference/get_predicted_flow_metrics.html">ffcAPIClient::get_predicted_flow_metrics(com_id)</a></code> to retrieve a data frame with only the results for that segment. For example, for the Goodyear’s Bar reference gage segment on the North Yuba:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="kw pkg">ffcAPIClient</span><span class="kw ns">::</span><span class="fu"><a href="../reference/get_predicted_flow_metrics.html">get_predicted_flow_metrics</a></span>(<span class="st">"8058513"</span>)</pre></body></html></div>
<pre><code>                Metric   COMID          p10          p25         p50          p75          p90 source
38433        DS_Dur_WS 8058513 8.467500e+01 1.146312e+02   145.00000 1.765000e+02 2.015200e+02  model
178679       DS_Mag_50 8058513 3.550966e+01 5.372067e+01    83.01238 1.227657e+02 1.446242e+02  model
318925       DS_Mag_90 8058513 7.209266e+01 1.018497e+02   156.52111 2.332115e+02 3.339129e+02  model
459171          DS_Tim 8058513 2.788200e+02 2.880000e+02   300.90000 3.115000e+02 3.241325e+02  model
583991          FA_Dur 8058513 2.000000e+00 3.000000e+00     4.00000 6.000000e+00 8.000000e+00    obs
670137          FA_Mag 8058513 1.129055e+02 1.711441e+02   270.44481 4.731658e+02 8.309241e+02  model
810383          FA_Tim 8058513 7.830000e+00 1.444375e+01    23.46667 3.002500e+01 4.729750e+01  model
950629         Peak_10 8058513 8.031502e+03 1.316898e+04 19158.34402 2.434368e+04 2.613562e+04  model
1090875        Peak_5 8058513 5.456749e+03 8.858951e+03 13062.81469 1.348278e+04 1.642180e+04  model
1231121        Peak_2 8058513 2.903039e+03 4.493501e+03  5484.65786 6.384782e+03 1.405851e+04  model
1355941    Peak_Dur_10 8058513 1.000000e+00 1.000000e+00     1.00000 2.000000e+00 4.000000e+00    obs
1426661    Peak_Dur_5 8058513 1.000000e+00 1.000000e+00     2.00000 3.000000e+00 6.000000e+00    obs
1497381    Peak_Dur_2 8058513 1.000000e+00 1.000000e+00     4.00000 1.000000e+01 2.900000e+01    obs
1568101    Peak_Fre_10 8058513 1.000000e+00 1.000000e+00     1.00000 1.000000e+00 2.000000e+00    obs
1638821    Peak_Fre_5 8058513 1.000000e+00 1.000000e+00     1.00000 2.000000e+00 3.000000e+00    obs
1709541    Peak_Fre_2 8058513 1.000000e+00 1.000000e+00     2.00000 3.000000e+00 5.000000e+00    obs
1795687         SP_Dur 8058513 4.600000e+01 5.500000e+01    67.86250 8.962500e+01 1.210167e+02  model
1935933         SP_Mag 8058513 1.338260e+03 1.826367e+03  2632.40321 4.145245e+03 6.601865e+03  model
2060753         SP_ROC 8058513 3.845705e-02 4.863343e-02     0.06250 8.132020e-02 1.141117e-01    obs
2146899         SP_Tim 8058513 1.805000e+02 2.149063e+02   232.00000 2.414292e+02 2.515050e+02  model
2287145    Wet_BFL_Dur 8058513 6.648750e+01 9.409375e+01   137.38750 1.738125e+02 1.970433e+02  model
2427391 Wet_BFL_Mag_10 8058513 1.370541e+02 2.052893e+02   333.09236 4.704166e+02 5.683843e+02  model
2567637 Wet_BFL_Mag_50 8058513 4.369753e+02 6.272972e+02   824.51279 1.083330e+03 1.360226e+03  model
2707883        Wet_Tim 8058513 4.638500e+01 5.857500e+01    72.42500 9.511667e+01 1.187900e+02  model</code></pre>
</div>
</div>
<div id="additional-ffc-options" class="section level2">
<h2 class="hasAnchor">
<a href="#additional-ffc-options" class="anchor"></a>Additional FFC Options</h2>
<p>There are many options that are available for the user to specify within the <strong><code>FFCProcessor</code></strong> object. These should be called prior to the <code>setup</code> and <code>run</code> functions, and some may be overwritten by parameters to <code>$setup</code>. Here are a few options to be aware of:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co"># set new processor</span>
<span class="no">ffc</span> <span class="kw">&lt;-</span> <span class="no">FFCProcessor</span>$<span class="fu">new</span>()

<span class="co"># then specify options:</span>
<span class="no">ffc</span>$<span class="no">date_field</span> <span class="kw">=</span> <span class="st">"date"</span> <span class="co"># change to whatever column name contains date</span>

<span class="co">## ADDITIONAL OPTIONS: ##</span>
<span class="co"># start_date = "10/1", # defaults to Water Year</span>
<span class="co"># date_format_string = "%m/%d/%Y", # specify the date format</span>
<span class="co"># date_field = "date",</span>
<span class="co"># flow_field = "flow",</span>
<span class="co"># comid = NA,</span>
<span class="co"># filter_ffc_results = TRUE,  # indicates whether we want to remove anything that's not a flow metric automatically (Julian day results, some diagnostics)</span>
<span class="co"># predicted_percentiles_online = TRUE,  # should we get predicted flow metrics from the online API, or with our offline data?</span>
<span class="co"># plots = NA,</span>
<span class="co"># plot_output_folder = NA,</span>
<span class="co"># alteration = NA,</span>
<span class="co"># fail_years_data = pkg.env$FAIL_YEARS_DATA, # stops processing if we have this many years or fewer after filtering, default is 10</span>
<span class="co"># warn_years_data = 15,  # we'll warn people if we have this many years or fewer after filtering</span>
<span class="co"># timeseries_enable_filtering = pkg.env$FILTER_TIMESERIES, # should we run the timeseries filtering? Stays TRUE internally, but the flag is here for advanced users</span>
<span class="co"># timeseries_max_missing_days = 7,</span>
<span class="co"># timeseries_max_consecutive_missing_days = 1,</span>
<span class="co"># timeseries_fill_gaps = "no",</span>
<span class="co"># timeseries_enable_filtering = pkg.env$FILTER_TIMESERIES, # should we run the timeseries filtering? Stays TRUE internally, but the flag is here for advanced users</span>
<span class="co"># gage_start_date = "", # start_date and end_date are passed straight through to readNWISdv - "" means "retrieve all". Override values should be of the form YYYY-MM-DD</span>
<span class="co"># gage_end_date = "",</span>
<span class="co"># SERVER_URL = 'https://eflows.ucdavis.edu/api/',</span>

<span class="co"># for example, set minimum years required to 2 and start water year to 1980</span>
<span class="no">ffc</span> <span class="kw">&lt;-</span> <span class="no">FFCProcessor</span>$<span class="fu">new</span>()
<span class="no">ffc</span>$<span class="no">timeseries_enable_filtering</span> <span class="kw">&lt;-</span> <span class="fl">TRUE</span>
<span class="no">ffc</span>$<span class="no">fail_years_data</span> <span class="kw">&lt;-</span> <span class="fl">2</span>
<span class="no">ffc</span>$<span class="no">gage_start_date</span> <span class="kw">&lt;-</span> <span class="st">"1979-10-01"</span>
<span class="no">ffc</span>$<span class="fu">set_up</span>(<span class="kw">gage_id</span><span class="kw">=</span><span class="fl">11264500</span>, <span class="kw">token</span> <span class="kw">=</span> <span class="no">ffctoken</span>)
<span class="no">ffc</span>$<span class="fu">run</span>()</pre></body></html></div>
</div>
<div id="known-issues" class="section level2">
<h2 class="hasAnchor">
<a href="#known-issues" class="anchor"></a>Known Issues</h2>
<ul>
<li>In some cases, the package fails to install using <code>devtools</code>. Upgrade your copy of devtools and the installation should proceed without error.</li>
<li>When providing a timeseries, if the <code>date</code> field is of type <code>date</code> rather than dates as formatted text, the filtering code will trigger an error. In the future, we will enable it to process these values correctly, but the workaround is to do any filtering on data gaps yourself and disable filtering by setting <code>ffc$timeseries_enable_filtering &lt;- TRUE</code> on your <code>FFCProcessor</code> object.</li>
</ul>
</div>
<div id="change-log" class="section level2 unlisted unnumbered">
<h2 class="hasAnchor">
<a href="#change-log" class="anchor"></a>Change Log</h2>
<div id="version-0-9-8-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-8-2" class="anchor"></a>Version 0.9.8.2</h3>
<ul>
<li>[Bugfix] Log messages weren’t going to the screen when running CEFF steps with an output folder. They once again go to both the screen and the output file. We now have a known issue where when it prints the FFC percentiles to the console, they don’t come out appropriately (due to our logging method) - use the output CSV instead in the meantime.</li>
</ul>
</div>
<div id="version-0-9-8-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-8-1" class="anchor"></a>Version 0.9.8.1</h3>
<ul>
<li>[Bugfix] Internal stream class data occasionally had multiple records, which would cause bad parameters to be sent to the FFC and a failure in the package. Now checks if there’s more than one stream class record and uses the first one.</li>
</ul>
</div>
<div id="version-0-9-8-0" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-8-0" class="anchor"></a>Version 0.9.8.0</h3>
<ul>
<li>[Enhancement] The package now checks to make sure it received a valid COMID from web services, which helps when the web service is down. It prints a warning if the lookup failed.</li>
<li>[Enhancement] The package now checks to make sure it obtained at least 24 predicted metric records. If it didn’t but received some, then it prints a warning. If it received no records, it prints an error about the COMID</li>
<li>[Enhancement] Added a new <code>$get_comid_online</code> (default TRUE) flag to FFCProcessor objects. The web service that we use to look up COMIDs for gages has been spotty recently, and we returned the option to do a lookup locally with spatial data. It will still download a large amount of spatial data for NHD segments the first time it runs with the flag set to FALSE, but then future lookups will be much faster. It uses the nhdR package, which is not included as a package requirement, and instead is installed only if you set <code>ffc$get_comid_online = FALSE</code>.</li>
</ul>
</div>
<div id="version-0-9-7-5" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-5" class="anchor"></a>Version 0.9.7.5</h3>
<ul>
<li>[Update] Included updated data for peak flow metric predictions into package data. To support this, we are temporarily changing the FFCProcessor object to use offline metrics instead of data from the TNC API. If you wish to use the API again, set <code>ffc$predicted_percentiles_online &lt;- TRUE</code>. We will revert it to using online data in the future once the API is updated</li>
</ul>
</div>
<div id="version-0-9-7-4" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-4" class="anchor"></a>Version 0.9.7.4</h3>
<ul>
<li>[Enhancement] New code that fills NA values in the 10th percentile column of predicted metrics from the TNC API if the 25th percentile column is 0. A warning will be raised if NA values are found in the 10th percentile column. Can be turned off by setting <code>ffc$predicted_percentiles_fill_na_p10</code> to FALSE.</li>
</ul>
</div>
<div id="version-0-9-7-3" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-3" class="anchor"></a>Version 0.9.7.3</h3>
<ul>
<li>[Bugfix] Previously, providing a timeseries with a date field that was not named “date” (case sensitive) would fail when building the data frame to send to the FFC. This has been fixed, and any date field name should be usable, so long as it is provided as a parameter, or set on the <code>ffc</code> object before running <code>ffc$set_up</code>.</li>
</ul>
</div>
<div id="version-0-9-7-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-2" class="anchor"></a>Version 0.9.7.2</h3>
<ul>
<li>[Update] Fixes for new versions of the eflows API launched recently. Everyone using this package will need to upgrade to this version or newer to keep using the package.</li>
</ul>
</div>
<div id="version-0-9-7-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-1" class="anchor"></a>Version 0.9.7.1</h3>
<ul>
<li>Added function <code>clean_account</code> to remove all current runs from the online FFC. Helps with broken accounts after recent FFC update. To use, just call <code><a href="../reference/clean_account.html">clean_account(token)</a></code> after setting your token value into the variable named <code>token</code>
</li>
</ul>
</div>
<div id="version-0-9-7-0" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-7-0" class="anchor"></a>Version 0.9.7.0</h3>
<ul>
<li>[Change] Data sent to the FFC is now filtered according to CEFF Tech Team determined rules - water years are dropped if they have more than 7 missing days or more than 2 consecutive missing days (by default). See the documentation for the function <code>filter_timeseries</code> for more info. It applies to both automatically retrieved gage data and user-provided timeseries. It can be disabled by setting timeseries_enable_filtering to FALSe on the FFCProcessor object, but you’re much better off just disabling it by filling gaps in your data yourself if you need to keep all water years.</li>
<li>[Enhancement] ffcAPIClient now logs both to the console and to a log file in the output folder, including the version of the package and any log messages (some R warnings and errors may not show up in the file yet)</li>
<li>[Change] The package now stops running if you have fewer than 10 years of data <em>after</em> the filters implemented in this version have run. It warns you, but still runs if you have fewer than 15 years of data. These apply whether the data source is gage data or a provided timeseries. To change this behavior, change the values of <code>fail_years_data</code> and <code>warn_years_data</code> on the FFCProcessor object</li>
<li>[Enhancement] You can now pass minimum and maximum dates for gage data retrieval. Set the values of <code>gage_start_date</code> and <code>gage_end_date</code> on the FFCProcessor object.</li>
</ul>
</div>
<div id="version-0-9-6-9" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-9" class="anchor"></a>Version 0.9.6.9</h3>
<ul>
<li>[Bugfix] Fixed issue preventing export of R6 Classes - FFCProcessor and USGSGage should now be available for use as the documentation describes</li>
</ul>
</div>
<div id="version-0-9-6-8" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-8" class="anchor"></a>Version 0.9.6.8</h3>
<ul>
<li>[Enhancement] Code available for three steps of CEFF process - working on documentation for it still</li>
</ul>
</div>
<div id="version-0-9-6-7" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-7" class="anchor"></a>Version 0.9.6.7</h3>
<ul>
<li>[Bugfix] Adjusted to change in FFM API from flows.codefornature.org</li>
<li>[Enhancement] Code available to support first step of CEFF process</li>
</ul>
</div>
<div id="version-0-9-6-6" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-6" class="anchor"></a>Version 0.9.6.6</h3>
<ul>
<li>[Enhancement] New function <code>force_consistent_naming</code> sets option to convert peak magnitude metrics to use same name format as other magnitude metrics. <code>Peak_2</code> becomes <code>Peak_Mag_2</code>, etc. Defaults to off to remain aligned with CEFF, but if you need metric names to follow a pattern, that will help. See documentation for usage.</li>
<li>[Change] Predicted flow metrics now use a character instead of a factor in the <code>metric</code> column.</li>
</ul>
</div>
<div id="version-0-9-6-5" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-5" class="anchor"></a>Version 0.9.6.5</h3>
<ul>
<li>[Enhancement] ffc_results dataframe now filters out non-metrics (things starting with __ or ending with _Julian)</li>
</ul>
</div>
<div id="version-0-9-6-4" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-4" class="anchor"></a>Version 0.9.6.4</h3>
<ul>
<li>[Bugfix] Handled a condition where the predicted flow metric API returns duplicate values for some metrics</li>
</ul>
</div>
<div id="version-0-9-6-3" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-3" class="anchor"></a>Version 0.9.6.3</h3>
<ul>
<li>[Bugfix] Fixed an error where predicted Spring Duration metrics came through as SP_Du</li>
</ul>
</div>
<div id="version-0-9-6-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-2" class="anchor"></a>Version 0.9.6.2</h3>
<ul>
<li>[Bugfix] Fixed error preventing <code>evaluate_alteration</code> from running with warnings about <code>date_format_string</code>.</li>
</ul>
</div>
<div id="version-0-9-6-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-1" class="anchor"></a>Version 0.9.6.1</h3>
<ul>
<li>[Enhancement] Updated plotting to facet each metric with a free Y axis so that all boxplots can be clearly seen. Other minor enhancements to plotting, like titles and X axis labels as well.</li>
</ul>
</div>
<div id="version-0-9-6-0" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-6-0" class="anchor"></a>Version 0.9.6.0</h3>
<ul>
<li>[Enhancement] <code>evaluate_alteration</code> family of functions now also returns <code>predicted_wyt_percentiles</code> in addition to the <code>predicted_percentiles</code>. The WYT form includes a <code>wyt</code> column that includes the water year type of the prediction</li>
<li>[Change] Using TNC’s online API to pull predicted flow metrics instead of internal data by default</li>
<li>[Change] Under the hood, the code behaves differently - most processing is now being handled in the FFCProcessor class, but more will be moved there</li>
</ul>
</div>
<div id="version-0-9-5-8" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-8" class="anchor"></a>Version 0.9.5.8</h3>
<ul>
<li>[Change] Updated the rules used to determine alteration to match new rules for CEFF Appendix F - specifically, we now <em>always</em> check that &gt;=50% of observations are within the i80r before declaring something unaltered.</li>
</ul>
</div>
<div id="version-0-9-5-7" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-7" class="anchor"></a>Version 0.9.5.7</h3>
<ul>
<li>[Enhancement] <code>evaluate_alteration</code> now supports parameter to control plotting (similar to <code>evaluate_gage_alteration</code>) and documentation has been added for the function.</li>
</ul>
</div>
<div id="version-0-9-5-6" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-6" class="anchor"></a>Version 0.9.5.6</h3>
<ul>
<li>[Enhancement] Added the ability to pull predicted metrics from TNC’s predicted metrics API instead of from internal data. To use it, set <code>online=TRUE</code> when calling <code>get_predicted_flow_metrics</code>. It includes one small difference - in the source field, values marked as <code>obs</code> in the offline data show up as <code>inferred</code>.</li>
</ul>
</div>
<div id="version-0-9-5-5" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-5" class="anchor"></a>Version 0.9.5.5</h3>
<ul>
<li>[Change] No longer look up gage COMIDs by default due to error-prone nature of lookup near stream junctions. Use <code>force_comid_lookup</code> parameter to <code>evaluate_gage_alteration</code> to enable previous lookup behavior.</li>
<li>[Enhancement] Added an automatic lookup that corrects bad data from comid lookups and returns the correct COMID. Only used for Jones Bar gage right now, but structure is there for if others are found.</li>
</ul>
</div>
<div id="version-0-9-5-4" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-4" class="anchor"></a>Version 0.9.5.4</h3>
<ul>
<li>[Breaking Change] Where found, column names have been fully lowercased for consistency, including Metric -&gt; metric and COMID -&gt; comid</li>
<li>[Breaking Change] Parameter <code>com_id</code> to <code>get_predicted_flow_metrics</code> was renamed <code>comid</code>
</li>
<li>[Enhancement] observed percentiles and predictions both include a <code>result_type</code> field, with observed FFC results containing the value “observed” and prediction percentiles fields containing the value “predicted” to allow for merging of the data frames in some contexts</li>
<li>[Enhancement] <code>evaluate_gage_alteration</code> now attaches a field <code>gage_id</code> to <code>predicted_percentiles</code>, <code>observed_percentiles</code>, and <code>alteration</code> data frames.</li>
<li>[Enhancement] observed percentiles now include a comid field to allow for merging and accessing the comid in other contexts</li>
<li>[Enhancement] <code>evaluate_alteration</code> and <code>evaluate_gage_alteration</code> now includes a fifth key <code>alteration</code> with the assessed flow alteration scores in a data frame</li>
</ul>
</div>
<div id="version-0-9-5-3" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-3" class="anchor"></a>Version 0.9.5.3</h3>
<ul>
<li>[Breaking Change] Results from <code>evaluate_alteration</code> and <code>evaluate_gage_alteration</code> now use the list key <code>ffc_percentiles</code> instead of simply <code>percentiles</code> to be clear that the percentiles are from the observed FFC results.</li>
<li>[Change] Changed quantile processing type to the default of type 7 so that observed FFC data are processed into percentiles the same way that the predicted flow metrics were calculated to minimize resulting error.</li>
<li>[Enhancement] <code>evaluate_alteration</code> and <code>evaluate_gage_alteration</code> now includes a fourth key <code>predicted_percentiles</code> with the predicted flow metric percentile values so they don’t need to be looked up separately.</li>
</ul>
</div>
<div id="version-0-9-5-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-2" class="anchor"></a>Version 0.9.5.2</h3>
<ul>
<li>[Enhancement] Added <code>annual</code> parameter to <code>assess_alteration</code> that runs a year over year analysis.</li>
</ul>
</div>
<div id="version-0-9-5-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5-1" class="anchor"></a>Version 0.9.5.1</h3>
<ul>
<li>[Enhancement] New parameter <code>plot</code> (boolean) to <code>evaluate_gage_alteration</code> controls whether the function produces plots or not</li>
</ul>
</div>
<div id="version-0-9-5" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-5" class="anchor"></a>Version 0.9.5</h3>
<ul>
<li>[Enhancement] New <code>assess_alteration</code> function returns a data frame with alteration results - documentation forthcoming.</li>
<li>[Change] Warning when can’t determine stream segment’s hydrogeomorphic type has been downgraded to a print statement.</li>
</ul>
</div>
<div id="version-0-9-4-2" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-4-2" class="anchor"></a>Version 0.9.4.2</h3>
<ul>
<li>[Breaking Change] The client now detects and sends the appropriate parameters to the FFC online for the stream class that it detects based on the COMID. If you are using low-level functions such as <code>get_ffc_results_for_df</code>, then you must provide an argument <code>comid</code> - check the documentation for which functions need it. Further,<code>process-data</code> now requires that the stream parameters be provided to it. I recommend moving to something like <code>get_ffc_results_for_df</code> as process_data may soon be moved to be internal only.</li>
</ul>
</div>
<div id="version-0-9-4-1" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-4-1" class="anchor"></a>Version 0.9.4.1</h3>
<ul>
<li>[Enhancement] New code to support sending the correct stream class parameters to the FFC - includes the ability to identify stream classes by COMID, but not yet send the parameters</li>
<li>[Change] Data loading code made more generic, and potentially faster - multiple calls to get predicted flow metrics should not result in reloading the dataset.</li>
</ul>
</div>
<div id="version-0-9-4" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-4" class="anchor"></a>Version 0.9.4</h3>
<ul>
<li>[Breaking Change] List item <code>$ffc_results_df</code> returned from <code>evaluate_alteration</code> functions changed to <code>$ffc_results</code> for consistency with FFCProcessor object and allowing for more flexibility in the future.</li>
<li>[Enhancement] Basic alteration assessment capabilities included. Require more testing before use</li>
<li>[Documentation] Reworking documentation to make best workflows clearer</li>
</ul>
</div>
<div id="version-0-9-3" class="section level3">
<h3 class="hasAnchor">
<a href="#version-0-9-3" class="anchor"></a>Version 0.9.3</h3>
<ul>
<li>[Enhancement] Can now provide a time format string to <code>evaluate_alteration</code> - it will use that to read the values in the time field and reformat them to send to the FFC as needed.</li>
<li>[Bugfix] FFC results no longer fail to transform if one flow metric is entirely NULL</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://nicksantos.com">Nick Santos</a>, <a href="https://ryanpeek.github.io/">Ryan Peek</a>, <a href="https://watershed.ucdavis.edu/people/alyssa-obester">Alyssa Obester</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
