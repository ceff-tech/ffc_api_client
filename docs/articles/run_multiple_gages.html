<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Run Multiple Gages • ffcAPIClient</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Run Multiple Gages">
<meta property="og:description" content="ffcAPIClient">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ffcAPIClient</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.9.8.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ceff-steps.html">Use ffcAPIClient to Follow CEFF Steps</a>
    </li>
    <li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/run_multiple_gages.html">Run Multiple Gages</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Run Multiple Gages</h1>
            
      
      
      <div class="hidden name"><code>run_multiple_gages.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="iterating-through-multiple-gages-with-ffcapiclient">Iterating through Multiple Gages with ffcAPIClient<a class="anchor" aria-label="anchor" href="#iterating-through-multiple-gages-with-ffcapiclient"></a>
</h2>
<p>This vignette demonstrates one approach to running multiple gages
through the FFC at once. It does require some knowledge of functions and
using the <a href="https://purrr.tidyverse.org/" class="external-link"><code>{purrr}</code></a> package in
R. It also assumes the user has already successfully been able to run a
single gage (see the vignette on <a href="https://ceff-tech.github.io/ffc_api_client/articles/ceff-steps.html" class="external-link">following
the CEFF steps</a>).</p>
<p>To work through this tutorial, we’ll need a a few packages that
aren’t part of the <strong>ffcAPIClient</strong>.</p>
<div class="section level3">
<h3 id="packages-for-iterating-over-a-list-of-gages">Packages for Iterating over a list of Gages<a class="anchor" aria-label="anchor" href="#packages-for-iterating-over-a-list-of-gages"></a>
</h3>
<p>These packages are needed. If you don’t have them installed, use
<code>install.packages("packagename")</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># main ffc package</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ffcAPIClient</span><span class="op">)</span>

<span class="co"># packages</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># for data wrangling</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span> <span class="co"># for iterating over lists and applying functions</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span> <span class="co"># good for pasting things together</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span> <span class="co"># for working with directories and files</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/collectivemedia/tictoc" class="external-link">tictoc</a></span><span class="op">)</span> <span class="co"># timing stuff</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span> <span class="co"># helps with setting home directory/path</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span> <span class="co"># for working with strings</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="loading-custom-functions">Loading Custom Functions<a class="anchor" aria-label="anchor" href="#loading-custom-functions"></a>
</h3>
<p>The following is a description of the custom functions that are used
to iterate over a list of gages. You can read them over and modify as
needed, or just load them and use them as-is.</p>
<hr>
<p><strong>Iteration with purrr</strong></p>
<p>These functions are flexible, you can add any additional
specifications to the <code>FFCProcessor</code> object that you would
like (i.e., changing the number of minimum years required, adjust the
date threshold, etc.). Currently the default is to save the
<code>alteration</code>, <code>ffc_results</code>,
<code>ffc_percentiles</code>, and <code>predicted_percentiles</code> to
individual csv’s for each gage. These can then be combined afterwards
(see below for second function to do so).</p>
<p>An important part of making this function work is the
<code>purr::possibly()</code> function that essentially allows the
iteration through gages to continue even if a single gage fails (e.g.,
due to missing data). Future versions of this function may provide
better ways of capturing information relating to why a gage didn’t run,
but most typically it is because there was insufficient data available
either from USGS or after ffcAPIClient filtered for quality. Note, if
you want to change the output location, you can change the paths in the
<code>dir_create</code> and <code>write_csv</code> functions.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># these functions written by R. Peek 2020 to facilitate iteration</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ffcAPIClient</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidyverse/glue" class="external-link">glue</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span>

<span class="co"># write a function to pull the data</span>
<span class="va">ffc_iter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">id</span>, <span class="va">startDate</span>, <span class="va">ffctoken</span><span class="op">=</span><span class="va">ffctoken</span>, <span class="va">dirToSave</span><span class="op">=</span><span class="st">"output/ffc"</span>, <span class="va">save</span><span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>
  
  <span class="co"># set save dir</span>
  <span class="va">outDir</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{here()}/{dirToSave}"</span><span class="op">)</span>
  <span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># start ffc processor</span>
  <span class="va">ffc</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/FFCProcessor.html">FFCProcessor</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
  <span class="co"># set special parameters for this run of the FFC</span>
  <span class="va">ffc</span><span class="op">$</span><span class="va">gage_start_date</span> <span class="op">=</span> <span class="va">startDate</span>
  <span class="va">ffc</span><span class="op">$</span><span class="va">fail_years_data</span> <span class="op">=</span> <span class="fl">10</span>  <span class="co"># tell it to indicate a failure if we don't have at least 10 water years of data after doing quality checks</span>
  <span class="va">ffc</span><span class="op">$</span><span class="va">warn_years_data</span> <span class="op">=</span> <span class="fl">12</span>  <span class="co"># warn us if it has at least 10, but not more than 12 years of data - quality of results will be lower - default is 15</span>
  <span class="co"># run the FFCProcessor's setup code, then run the FFC itself</span>
  <span class="va">ffc</span><span class="op">$</span><span class="fu">set_up</span><span class="op">(</span>gage_id <span class="op">=</span> <span class="va">id</span>, token<span class="op">=</span><span class="va">ffctoken</span><span class="op">)</span>
  <span class="va">ffc</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="va">save</span><span class="op">==</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}"</span><span class="op">)</span><span class="op">)</span>
    <span class="co"># write out</span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">ffc</span><span class="op">$</span><span class="va">alteration</span>, file <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}/{id}_alteration.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">ffc</span><span class="op">$</span><span class="va">ffc_results</span>, file <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}/{id}_ffc_results.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">ffc</span><span class="op">$</span><span class="va">ffc_percentiles</span>, file<span class="op">=</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}/{id}_ffc_percentiles.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">ffc</span><span class="op">$</span><span class="va">predicted_percentiles</span>, file<span class="op">=</span><span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{outDir}/{id}_predicted_percentiles.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">ffc</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># wrap in possibly to permit error catching</span>
<span class="co"># see helpful post here: https://aosmith.rbind.io/2020/08/31/handling-errors/</span>
<span class="va">ffc_possible</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html" class="external-link">possibly</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="va">ffc_iter</span>, otherwise <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span></code></pre></div>
<p>To use this function, you can copy and paste the above, or save it to
a script, or <a href="https://raw.githubusercontent.com/ryanpeek/ffm_comparison/main/R/f_iterate_ffc.R" class="external-link">download
from here</a>. Load the function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># if saved locally</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/f_iterate_ffc.R"</span><span class="op">)</span>

<span class="co"># if sourcing from the web</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/ryanpeek/ffm_comparison/main/R/f_iterate_ffc.R"</span><span class="op">)</span></code></pre></div>
<p><br></p>
<p><strong>Function to Collapse output csvs</strong></p>
<p>This function helps us read in our data that we saved using the
function above. This function assumes things are in
<code>output/ffc</code>. Similarly, can load from a file saved locally,
or from online version.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org" class="external-link">fs</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span>

<span class="co"># need function to read in and collapse different ffc outputs</span>
<span class="va">ffc_collapse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">datatype</span>, <span class="va">fdir</span><span class="op">)</span><span class="op">{</span>
  <span class="va">datatype</span> <span class="op">=</span> <span class="va">datatype</span>
  <span class="va">csv_list</span> <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">fdir</span>, regexp <span class="op">=</span> <span class="va">datatype</span><span class="op">)</span>
  <span class="va">csv_names</span> <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_file.html" class="external-link">path_file</a></span><span class="op">(</span><span class="va">csv_list</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_file.html" class="external-link">path_ext_remove</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">gage_ids</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">csv_names</span>, <span class="st">'([0-9])+'</span><span class="op">)</span>
  <span class="co"># read in all</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">csv_list</span>, <span class="op">~</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_df</a></span><span class="op">(</span><span class="va">gage_ids</span>, <span class="op">~</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.x</span>,gageid<span class="op">=</span><span class="va">.y</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Load the function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># saved locally</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"R/f_ffc_collapse.R"</span><span class="op">)</span>

<span class="co"># load from link</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/ryanpeek/ffm_comparison/main/R/f_ffc_collapse.R"</span><span class="op">)</span></code></pre></div>
<p><br></p>
</div>
<div class="section level3">
<h3 id="get-list-of-usgs-gages-to-run">Get List of USGS Gages to Run<a class="anchor" aria-label="anchor" href="#get-list-of-usgs-gages-to-run"></a>
</h3>
<p>Once we have our functions loaded, we can set up our list of gages.
This is an example list which includes a few USGS gages that should
<em>not</em> return data, because there is an insufficent period of
record available to calculate the FF metrics.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gage_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"09423350"</span>, <span class="st">"09427600"</span>, <span class="st">"11427000"</span>, <span class="st">"09529700"</span>, <span class="st">"11394500"</span>, <span class="st">"11264500"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setup-iteration">Setup Iteration<a class="anchor" aria-label="anchor" href="#setup-iteration"></a>
</h3>
<p>Here we can setup parameters used in the iteration function.
Currently this is essentially only the start date.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set start date to start WY 1980</span>
<span class="va">st_date</span> <span class="op">&lt;-</span> <span class="st">"1979-10-01"</span>

<span class="co"># set your ffc token here:</span>
<span class="va">ffctoken</span> <span class="op">&lt;-</span> <span class="st">"your_token_here"</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-iteration-function">Run Iteration Function<a class="anchor" aria-label="anchor" href="#run-iteration-function"></a>
</h3>
<p>Then we can run these and generate our data (as csvs), which we will
then read back into R and collapse into a single file for use in
analysis. We run the iterate function to pull the data. Note, any gage
that returns an <code>NA</code> did not have sufficient data for the FFC
to calculate metrics.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">tic</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># start time</span>
<span class="va">ffcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">gage_list</span>, <span class="op">~</span><span class="fu">ffc_possible</span><span class="op">(</span><span class="va">.x</span>, startDate <span class="op">=</span> <span class="va">st_date</span>, ffctoken<span class="op">=</span><span class="va">ffctoken</span>, dirToSave<span class="op">=</span><span class="st">"output/ffc_run"</span>, save<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="co"># add names to list</span>
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.</span>, nm<span class="op">=</span><span class="va">gage_list</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/tictoc/man/tic.html" class="external-link">toc</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># end time</span></code></pre></div>
<p>After running this, we should see two things. First, the printout
should look something like this for each gage run:</p>
<pre><code>INFO [2020-11-17 12:20:48] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:20:48] Excluding water years 1982 for having more than 7 missing days of data
INFO [2020-11-17 12:20:48] Excluding water years 2021 for having more than 7 missing days of data
INFO [2020-11-17 12:20:48] Using date format string %m/%d/%Y
WARN [2020-11-17 12:20:48] Received an insufficient number of predicted metric rows, which may cause failures at a later step. Check that the found COMID printed by the package is correct, and if it's not, specify the COMID manually, which may resolve this issue. You may want to report this error at https://github.com/ceff-tech/ffcapiclient/issues so we can make sure to have complete predicted metric data
INFO [2020-11-17 12:20:49] Couldn't find stream class for COMID or no COMID provided (Provided value: 10017314). Sending the general parameters to the FFC online, which may result in different results than if a COMID was provided or could be found
WARN [2020-11-17 12:20:52] Less than 10 years of data...try again
INFO [2020-11-17 12:20:52] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:20:54] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:20:54] Excluding water years 2021 for having more than 7 missing days of data
INFO [2020-11-17 12:20:54] Using date format string %m/%d/%Y
INFO [2020-11-17 12:20:55] COMID 14996611 is of stream class LSR - sending parameters to FFC online for that stream class. This may produce different results than if you run data through the FFC yourself using their default parameters.
INFO [2020-11-17 12:21:06] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:21:06] Excluding water years 2005 for having more than 7 missing days of data
INFO [2020-11-17 12:21:06] Excluding water years 2017 for having more than 7 missing days of data
INFO [2020-11-17 12:21:06] Using date format string %m/%d/%Y
WARN [2020-11-17 12:21:06] Received an insufficient number of predicted metric rows, which may cause failures at a later step. Check that the found COMID printed by the package is correct, and if it's not, specify the COMID manually, which may resolve this issue. You may want to report this error at https://github.com/ceff-tech/ffcapiclient/issues so we can make sure to have complete predicted metric data
INFO [2020-11-17 12:21:06] Couldn't find stream class for COMID or no COMID provided (Provided value: 21411963). Sending the general parameters to the FFC online, which may result in different results than if a COMID was provided or could be found
INFO [2020-11-17 12:21:12] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:21:12] Excluding water years  for having more than 7 missing days of data
ERROR [2020-11-17 12:21:12] Can't proceed - too few water years (7) remaining after filtering to complete years.
INFO [2020-11-17 12:21:15] ffcAPIClient Version 0.9.8.1
INFO [2020-11-17 12:21:15] Excluding water years 2021 for having more than 7 missing days of data
INFO [2020-11-17 12:21:15] Using date format string %m/%d/%Y
INFO [2020-11-17 12:21:15] COMID 21609533 is of stream class SM - sending parameters to FFC online for that stream class. This may produce different results than if you run data through the FFC yourself using their default parameters.
36.471 sec elapsed</code></pre>
<p>We should now have a <code>output/ffc</code> directory with <em>4 csv
files</em> for each gage, listed as <code>gage_no</code> and then the
data type (<code>alteration</code>, <code>ffc_percentiles</code>,
<code>ffc_results</code>, and <code>predicted_percentiles</code>). We
can now move to the next step of reading these data in and combining
them into a single file for each data type.</p>
<p>One thing that may be helpful, is to make a list of the gages that
<strong>didn’t</strong> return data. These can be double checked later.
Here’s some code that may help do that, assuming you have a
<code>ffcs</code> object in you environment.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># identify missing:</span>
<span class="va">ffcs</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html" class="external-link">keep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># make a list of missing gages for future use</span>
<span class="va">miss_gages</span> <span class="op">&lt;-</span> <span class="va">ffcs</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html" class="external-link">keep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># which gages?</span>
<span class="va">miss_gages</span>

<span class="co"># save out missing to a file</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/read_lines.html" class="external-link">write_lines</a></span><span class="op">(</span><span class="va">miss_gages</span>, file <span class="op">=</span> <span class="st">"output/usgs_ffcs_gages_alt_missing_data.txt"</span><span class="op">)</span></code></pre></div>
<pre><code>[1] 2 # two missing data

[1] "09427600" "11394500" # gages missing data</code></pre>
</div>
<div class="section level3">
<h3 id="collapse-ffc-results-into-single-file">Collapse FFC Results into Single File<a class="anchor" aria-label="anchor" href="#collapse-ffc-results-into-single-file"></a>
</h3>
<p>This step is not necessary, but it is helpful to have a single file
for each of the data types (i.e., <code>alteration</code> or
<code>ffc_results</code>), containing the metric information for each
gage. The following function is one approach to doing this iteratively
(imagine if you have 100 gages…reading in one by one would take
awhile).</p>
<p>Assuming we have loaded our function, we then need tell the function
what data type we want to collapse.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># source the function</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/ryanpeek/ffm_comparison/main/R/f_ffc_collapse.R"</span><span class="op">)</span>

<span class="co"># set the data type we want to collapse</span>
<span class="va">datatype</span><span class="op">=</span><span class="st">"predicted_percentiles"</span>

<span class="co"># Data Type options:</span>
<span class="co">## alteration</span>
<span class="co">## ffc_percentiles</span>
<span class="co">## ffc_results</span>
<span class="co">## predicted_percentiles</span>

<span class="co"># set directory where the raw .csv's live</span>
<span class="va">fdir</span><span class="op">=</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{here::here()}/output/ffc_run/"</span><span class="op">)</span>

<span class="co"># run it!</span>
<span class="va">df_ffc</span> <span class="op">&lt;-</span> <span class="fu">ffc_collapse</span><span class="op">(</span><span class="va">datatype</span>, <span class="va">fdir</span><span class="op">)</span>

<span class="co"># view how many gages</span>
<span class="va">df_ffc</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">gageid</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># how many FF metrics per gage?</span>
<span class="va">df_ffc</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">gageid</span><span class="op">)</span> <span class="op"><a href="https://purrr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># save it</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">df_ffc</span>, file <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"{here::here()}/output/usgs_alt_{datatype}_run_{Sys.Date()}.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://nicksantos.com" class="external-link">Nick Santos</a>, <a href="https://ryanpeek.github.io/" class="external-link">Ryan Peek</a>, <a href="https://watershed.ucdavis.edu/people/alyssa-obester" class="external-link">Alyssa Obester</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
